module.exports=[51766,e=>{"use strict";e.s(["copyTradeEngine",()=>s],51766);var t=e.i(26500),o=e.i(59261);!function(e){e.PROPORTIONAL="proportional",e.FIXED_DOLLAR="fixed_dollar",e.FIXED_SHARES="fixed_shares",e.RISK_BASED="risk_based",e.MULTIPLIER="multiplier"}({});let r=new class{calculatePositionSize(e,t,o,r,i){let s=e.position_sizing_method,a=o||i;switch(s){case"proportional":return this._proportionalSizing(e.allocation_percent||10,r,a,e.max_position_size);case"fixed_dollar":return this._fixedDollarSizing(e.fixed_dollar_amount,a,e.max_position_size);case"fixed_shares":return this._fixedSharesSizing(e.fixed_shares_amount,a,e.max_position_size);case"risk_based":return this._riskBasedSizing(e.risk_percent,e.auto_stop_loss_percent,r,a,e.max_position_size);case"multiplier":return this._multiplierSizing(e.multiplier,t,a,e.max_position_size);default:return console.error(`Unknown position sizing method: ${s}`),{quantity:0,estimated_cost:0,method_used:"error",capped:!1}}}_proportionalSizing(e,t,o,r){(!e||e<=0)&&(e=10);let i=e/100*t,s=!1;r&&i>r&&(i=r,s=!0);let a=o>0?Math.floor(i/o):0;return 0===a&&i>=o&&o>0&&(a=1),{quantity:a,estimated_cost:a*o,method_used:"proportional",capped:s}}_fixedDollarSizing(e,t,o){if(!e||e<=0)return console.error("Fixed dollar amount not set"),{quantity:0,estimated_cost:0,method_used:"error",capped:!1};let r=e,i=!1;o&&r>o&&(r=o,i=!0);let s=t>0?Math.floor(r/t):0;return 0===s&&r>=t&&t>0&&(s=1),{quantity:s,estimated_cost:s*t,method_used:"fixed_dollar",capped:i}}_fixedSharesSizing(e,t,o){if(!e||e<=0)return console.error("Fixed shares amount not set"),{quantity:0,estimated_cost:0,method_used:"error",capped:!1};let r=Math.floor(e),i=r*t,s=!1;return o&&i>o&&(i=(r=t>0?Math.floor(o/t):0)*t,s=!0),{quantity:r,estimated_cost:i,method_used:"fixed_shares",capped:s}}_riskBasedSizing(e,t,o,r,i){if(!e||e<=0)return console.error("Risk percent not set"),{quantity:0,estimated_cost:0,method_used:"error",capped:!1};(!t||t<=0)&&(console.warn("Stop-loss percent not set, defaulting to 5%"),t=5);let s=e/100*o/t*100,a=!1;i&&s>i&&(s=i,a=!0);let n=r>0?Math.floor(s/r):0;return 0===n&&s>=r&&r>0&&(n=1),{quantity:n,estimated_cost:n*r,method_used:"risk_based",capped:a}}_multiplierSizing(e,t,o,r){if(!e||e<=0)return console.error("Multiplier not set"),{quantity:0,estimated_cost:0,method_used:"error",capped:!1};let i=Math.floor(t*e);i<1&&(i=1);let s=i*o,a=!1;return r&&s>r&&(s=(i=o>0?Math.floor(r/o):0)*o,a=!0),{quantity:i,estimated_cost:s,method_used:"multiplier",capped:a}}calculateStopLossPrice(e,t,o){return"BUY"===o.toUpperCase()?Math.round(e*(1-t/100)*100)/100:Math.round(e*(1+t/100)*100)/100}calculateTakeProfitPrice(e,t,o){return"BUY"===o.toUpperCase()?Math.round(e*(1+t/100)*100)/100:Math.round(e*(1-t/100)*100)/100}},i=new class{sectorMapping={AAPL:"Technology",MSFT:"Technology",GOOGL:"Technology",AMZN:"Consumer Cyclical",TSLA:"Consumer Cyclical",JPM:"Financial Services",BAC:"Financial Services",XOM:"Energy",CVX:"Energy",JNJ:"Healthcare",PFE:"Healthcare"};marketCapData={AAPL:2800,MSFT:2500,GOOGL:1700,AMZN:1400,TSLA:800,JPM:450};async shouldCopyTrade(e,t,o,r,i,s){let a=this._checkTradeFilters(e,t);if(!a.shouldCopy)return a;let n=this._checkExposureLimits(e,t,o,r,i,s);return n.shouldCopy?{shouldCopy:!0}:n}_checkTradeFilters(e,t){if(t.skip_penny_stocks&&e.price&&e.price<5)return{shouldCopy:!1,skipReason:`Penny stock ($${e.price.toFixed(2)} < $5.00)`};if(t.skip_options&&"OPTION"===e.asset_type)return{shouldCopy:!1,skipReason:"Options trades disabled"};if(t.skip_0dte_options&&"OPTION"===e.asset_type&&e.expiration_date)try{let t=new Date(e.expiration_date),o=new Date,r=Math.floor((t.getTime()-o.getTime())/864e5);if(0===r)return{shouldCopy:!1,skipReason:"0DTE options disabled"}}catch(e){}if(t.skip_crypto&&"CRYPTO"===e.asset_type)return{shouldCopy:!1,skipReason:"Crypto trades disabled"};if(t.filter_by_market_cap){let o=this._getMarketCap(e.symbol);if(o){if(t.min_market_cap&&o<t.min_market_cap)return{shouldCopy:!1,skipReason:`Market cap $${o.toFixed(1)}B < min $${t.min_market_cap.toFixed(1)}B`};if(t.max_market_cap&&o>t.max_market_cap)return{shouldCopy:!1,skipReason:`Market cap $${o.toFixed(1)}B > max $${t.max_market_cap.toFixed(1)}B`}}}if(t.filter_by_price&&e.price){if(t.min_stock_price&&e.price<t.min_stock_price)return{shouldCopy:!1,skipReason:`Price $${e.price.toFixed(2)} < min $${t.min_stock_price.toFixed(2)}`};if(t.max_stock_price&&e.price>t.max_stock_price)return{shouldCopy:!1,skipReason:`Price $${e.price.toFixed(2)} > max $${t.max_stock_price.toFixed(2)}`}}if(t.filter_by_sector){let o=this._getSector(e.symbol);if(o){if(t.allowed_sectors&&!t.allowed_sectors.split(",").map(e=>e.trim()).includes(o))return{shouldCopy:!1,skipReason:`Sector '${o}' not in allowed list`};if(t.blocked_sectors&&t.blocked_sectors.split(",").map(e=>e.trim()).includes(o))return{shouldCopy:!1,skipReason:`Sector '${o}' is blocked`}}}return{shouldCopy:!0}}_checkExposureLimits(e,t,o,r,i,s){if(!t.enable_exposure_limits)return{shouldCopy:!0};let a=o>0?o:1e4;if(t.max_open_positions&&Object.keys(r).length>=t.max_open_positions)return{shouldCopy:!1,skipReason:`Max open positions reached (${t.max_open_positions})`};if(t.max_position_concentration){let o=e.quantity*(e.price||100),i=((r[e.symbol]?.value||0)+o)/a*100;if(i>t.max_position_concentration)return{shouldCopy:!1,skipReason:`Position concentration ${i.toFixed(1)}% > max ${t.max_position_concentration.toFixed(1)}%`}}if(t.max_sector_concentration){let o=this._getSector(e.symbol);if(o){let i=(this._calculateSectorExposure(o,r,a)*a/100+e.quantity*(e.price||100))/a*100;if(i>t.max_sector_concentration)return{shouldCopy:!1,skipReason:`Sector '${o}' concentration ${i.toFixed(1)}% > max ${t.max_sector_concentration.toFixed(1)}%`}}}if(t.max_daily_trades&&i>=t.max_daily_trades)return{shouldCopy:!1,skipReason:`Daily trade limit reached (${t.max_daily_trades})`};if(t.max_daily_volume){let o=e.quantity*(e.price||100);if(s+o>t.max_daily_volume)return{shouldCopy:!1,skipReason:`Daily volume limit would be exceeded ($${(s+o).toFixed(2)} > $${t.max_daily_volume.toFixed(2)})`}}return{shouldCopy:!0}}_calculateSectorExposure(e,t,o){let r=0;for(let[o,i]of Object.entries(t))this._getSector(o)===e&&(r+=i.value);return o>0?r/o*100:0}_getMarketCap(e){return this.marketCapData[e]}_getSector(e){return this.sectorMapping[e]}getFilterSummary(e){let t=[],o=[];return e.skip_penny_stocks&&t.push("Skip penny stocks (<$5)"),e.skip_options&&t.push("Skip all options"),e.skip_0dte_options&&t.push("Skip 0DTE options"),e.filter_by_market_cap&&(e.min_market_cap&&t.push(`Min market cap: $${e.min_market_cap}B`),e.max_market_cap&&t.push(`Max market cap: $${e.max_market_cap}B`)),e.filter_by_price&&(e.min_stock_price&&t.push(`Min price: $${e.min_stock_price}`),e.max_stock_price&&t.push(`Max price: $${e.max_stock_price}`)),e.filter_by_sector&&(e.allowed_sectors&&t.push(`Allowed sectors: ${e.allowed_sectors}`),e.blocked_sectors&&t.push(`Blocked sectors: ${e.blocked_sectors}`)),e.enable_exposure_limits&&(e.max_position_concentration&&o.push(`Max position: ${e.max_position_concentration}%`),e.max_sector_concentration&&o.push(`Max sector: ${e.max_sector_concentration}%`),e.max_open_positions&&o.push(`Max positions: ${e.max_open_positions}`),e.max_daily_trades&&o.push(`Max daily trades: ${e.max_daily_trades}`),e.max_daily_volume&&o.push(`Max daily volume: $${e.max_daily_volume.toLocaleString()}`)),{active_filters:t,active_limits:o,total_protections:t.length+o.length}}},s=new class{maxRetries=3;async getActiveFollowers(e){let o=(0,t.createServiceRoleClient)(),{data:r,error:i}=await o.from("copy_relationships").select("*").eq("leader_id",e).eq("status","active");return i?(console.error("Error fetching active followers:",i),[]):r||[]}async getFollowerAccount(e){let o=(0,t.createServiceRoleClient)(),{data:r,error:i}=await o.from("brokerage_connections").select("*").eq("user_id",e).eq("status","active").limit(1).single();return i?(console.error("Error fetching follower account:",i),null):r}async getUniversalSymbolId(e,t,r){try{let e=await o.snaptradeService.searchSymbols(r),t=e.find(e=>e.symbol?.symbol?.toUpperCase()===r.toUpperCase());if(t)return t.symbol?.id||null;return e[0]?.symbol?.id||null}catch(e){return console.error(`Error searching for symbol ${r}:`,e),null}}async executeWithRetry(e,t){let o=null;for(let r=0;r<this.maxRetries;r++)try{return await e()}catch(e){if(o=e,r<this.maxRetries-1){let e=Math.pow(2,r);console.warn(`Attempt ${r+1}/${this.maxRetries} failed for ${t}: ${o.message}. Retrying in ${e}s...`),await new Promise(t=>setTimeout(t,1e3*e))}else console.error(`All ${this.maxRetries} attempts failed for ${t}: ${o.message}`)}throw o}async getCurrentPositions(e){let o=(0,t.createServiceRoleClient)(),{data:r,error:i}=await o.from("copy_executions").select("symbol, action, quantity, executed_price").eq("relationship_id",e).eq("status","success");if(i||!r)return{};let s={};for(let e of r){s[e.symbol]||(s[e.symbol]={quantity:0,value:0});let t=e.quantity,o=e.executed_price||0;"buy"===e.action?(s[e.symbol].quantity+=t,s[e.symbol].value+=t*o):(s[e.symbol].quantity-=t,s[e.symbol].value-=t*o)}return Object.keys(s).forEach(e=>{s[e].quantity<=0&&delete s[e]}),s}async getTodayStats(e){let o=(0,t.createServiceRoleClient)(),r=new Date;r.setHours(0,0,0,0);let{data:i,error:s}=await o.from("copy_executions").select("quantity, executed_price").eq("relationship_id",e).eq("status","success").gte("created_at",r.toISOString());return s||!i?{count:0,volume:0}:{count:i.length,volume:i.reduce((e,t)=>e+t.quantity*(t.executed_price||0),0)}}async executeCopyTrade(e,s,a,n){let c=(0,t.createServiceRoleClient)(),l={trade_id:e.id,relationship_id:s.id,follower_id:a.id,symbol:e.symbol,action:e.action,quantity:0,status:"pending",account_id:n.account_id,asset_type:e.asset_type};try{let[t,d]=await Promise.all([this.getCurrentPositions(s.id),this.getTodayStats(s.id)]),p=await i.shouldCopyTrade({symbol:e.symbol,price:e.price,quantity:e.quantity,action:"buy"===e.action?"BUY":"SELL",asset_type:e.asset_type.toUpperCase(),expiration_date:e.expiration_date},s,n.balance,t,d.count,d.volume);if(!p.shouldCopy){l.status="skipped",l.error_message=`Filtered: ${p.skipReason}`;let{error:e}=await c.from("copy_executions").insert(l);return e&&console.error("Error saving skipped execution:",e),console.info(`Trade skipped for follower ${a.id}: ${p.skipReason}`),{execution:l,success:!1,error:p.skipReason}}let u=await this.getUniversalSymbolId(a.snaptrade_user_id,a.snaptrade_user_secret,e.symbol);if(!u){l.status="failed",l.error_message=`Symbol ${e.symbol} not found`;let{error:t}=await c.from("copy_executions").insert(l);return t&&console.error("Error saving failed execution:",t),{execution:l,success:!1,error:l.error_message}}let _=e.price||0;if(0===_)try{_=(await o.snaptradeService.getStockQuote(a.snaptrade_user_id,a.snaptrade_user_secret,n.account_id,e.symbol)).price}catch{_=100}let m=r.calculatePositionSize(s,e.quantity,e.price,n.balance,_);if(l.quantity=m.quantity,console.info(`Position sizing: method=${m.method_used}, quantity=${m.quantity}, cost=$${m.estimated_cost.toFixed(2)}, capped=${m.capped}`),0===m.quantity){l.status="skipped",l.error_message="Position size calculated as 0";let{error:e}=await c.from("copy_executions").insert(l);return e&&console.error("Error saving execution:",e),{execution:l,success:!1,error:l.error_message}}let y=await o.snaptradeService.checkTradeImpact(a.snaptrade_user_id,a.snaptrade_user_secret,n.account_id,e.action.toUpperCase(),u,"Market",m.quantity);if(!y||!y.trade){l.status="failed",l.error_message="Trade impact validation failed";let{error:e}=await c.from("copy_executions").insert(l);return e&&console.error("Error saving execution:",e),{execution:l,success:!1,error:l.error_message}}let f=y.trade.id,x=await this.executeWithRetry(()=>o.snaptradeService.placeOrder(a.snaptrade_user_id,a.snaptrade_user_secret,f,!0),`place order for ${e.symbol}`);if(l.status="success",l.order_id=x.order_id,l.executed_at=new Date().toISOString(),l.executed_price=x.executed_price||_,console.info(`Copy trade executed: follower=${a.id}, symbol=${e.symbol}, action=${e.action}, quantity=${m.quantity}, price=$${l.executed_price.toFixed(2)}`),s.auto_stop_loss_enabled&&s.auto_stop_loss_percent)try{let t=r.calculateStopLossPrice(l.executed_price,s.auto_stop_loss_percent,e.action.toUpperCase());l.stop_loss_price=t,console.info(`Stop-loss calculated: price=$${t.toFixed(2)}`)}catch(e){console.error("Failed to place stop-loss order:",e)}if(s.auto_take_profit_enabled&&s.auto_take_profit_percent)try{let t=r.calculateTakeProfitPrice(l.executed_price,s.auto_take_profit_percent,e.action.toUpperCase());l.take_profit_price=t,console.info(`Take-profit calculated: price=$${t.toFixed(2)}`)}catch(e){console.error("Failed to place take-profit order:",e)}await c.from("copy_relationships").update({total_trades_copied:s.total_trades_copied+1}).eq("id",s.id);let{error:h}=await c.from("copy_executions").insert(l);return h&&console.error("Error saving successful execution:",h),await c.from("notifications").insert({user_id:a.id,type:"trade_executed",title:"Trade Executed",message:`Copied ${e.action} ${m.quantity} ${e.symbol} at $${l.executed_price.toFixed(2)}`,metadata:{trade_id:e.id,symbol:e.symbol,action:e.action,quantity:m.quantity,price:l.executed_price}}),{execution:l,success:!0}}catch(o){l.status="failed",l.error_message=o.message,console.error(`Error executing copy trade for follower ${a.id}:`,o);let{error:t}=await c.from("copy_executions").insert(l);return t&&console.error("Error saving failed execution:",t),await c.from("notifications").insert({user_id:a.id,type:"trade_failed",title:"Trade Failed",message:`Failed to copy ${e.action} ${e.symbol}: ${l.error_message}`,metadata:{trade_id:e.id,symbol:e.symbol,error:l.error_message}}),{execution:l,success:!1,error:l.error_message}}}async processTrade(e){let o=(0,t.createServiceRoleClient)(),r=await this.getActiveFollowers(e.leader_id);console.info(`Processing trade ${e.id} for ${r.length} followers`);let i=[];for(let t of r){let{data:r}=await o.from("users").select("*").eq("id",t.follower_id).single();if(!r){console.warn(`Follower ${t.follower_id} not found`);continue}let s=await this.getFollowerAccount(r.id);if(!s){console.warn(`No account found for follower ${r.id}`);let s={trade_id:e.id,relationship_id:t.id,follower_id:r.id,symbol:e.symbol,action:e.action,quantity:0,status:"skipped",error_message:"No brokerage account connected",account_id:"none"};await o.from("copy_executions").insert(s),i.push({execution:s,success:!1,error:s.error_message});continue}let a=await this.executeCopyTrade(e,t,r,s);i.push(a)}return i}async processAllPendingTrades(){let e=(0,t.createServiceRoleClient)(),{data:o,error:r}=await e.from("leader_trades").select("*").eq("processed",!1).order("detected_at",{ascending:!0});if(r||!o)return console.error("Error fetching pending trades:",r),{totalTrades:0,totalExecutions:0,successfulExecutions:0,failedExecutions:0,skippedExecutions:0};let i={totalTrades:o.length,totalExecutions:0,successfulExecutions:0,failedExecutions:0,skippedExecutions:0};for(let t of(console.info(`Processing ${o.length} pending trades`),o)){let o=await this.processTrade(t);i.totalExecutions+=o.length,i.successfulExecutions+=o.filter(e=>e.success).length,i.failedExecutions+=o.filter(e=>!e.success&&"failed"===e.execution.status).length,i.skippedExecutions+=o.filter(e=>"skipped"===e.execution.status).length,await e.from("leader_trades").update({processed:!0}).eq("id",t.id)}return console.info("Processing complete:",i),i}}}];

//# sourceMappingURL=src_lib_trading_copy-engine_ts_2bc731bf._.js.map